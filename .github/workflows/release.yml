# 发布工作流
# 此工作流负责：
# 1. 下载Build工作流生成的所有平台构建产物
# 2. 打包仓库源码
# 3. 将构建产物和源码包上传到GitHub Release

name: Release

on:
  push:
    tags: [v*]

# 定义工作流所需的权限
permissions:
  contents: write # 需要写入内容的权限以创建Release

jobs:
  # 发布作业
  release:
    # 只在macOS上运行
    runs-on: macos-latest

    # 只在推送v开头的标签时执行此任务
    if: startsWith(github.ref_name, 'v')
    steps:
      # 检出代码（用于创建源码包）
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # 获取完整的git历史

      # 获取当前标签名
      - name: Get tag information
        id: get_tag
        run: echo "tag_name=${{ github.ref_name }}" >> $GITHUB_OUTPUT

      # 安装依赖
      - name: Install dependencies
        run: brew install ncurses

      # 设置CMake环境
      - name: Set up CMake
        uses: jwlawson/actions-setup-cmake@v2
        with:
          cmake-version: "latest"

      # 构建项目（amd64架构）
      - name: Build for amd64
        run: |
          rm -rf bin/  # 清理bin目录
          mkdir -p build-amd64
          cd build-amd64
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=x86_64
          make -j$(nproc)
          cd ..
          ls -la bin/ || echo "bin directory not found"

      # 打包amd64构建产物
      - name: Package amd64 artifact
        run: |
          mkdir -p artifacts
          cp bin/snake artifacts/snake-macos-amd64
          cd artifacts
          zip -r snake-macos-amd64.zip snake-macos-amd64
          rm snake-macos-amd64
          ls -la .

      # 构建项目（arm64架构）
      - name: Build for arm64
        run: |
          rm -rf bin/  # 清理bin目录
          mkdir -p build-arm64
          cd build-arm64
          cmake .. -DCMAKE_BUILD_TYPE=Release -DCMAKE_OSX_ARCHITECTURES=arm64
          make -j$(nproc)
          cd ..
          ls -la bin/ || echo "bin directory not found"

      # 打包arm64构建产物
      - name: Package arm64 artifact
        run: |
          cp bin/snake artifacts/snake-macos-arm64
          cd artifacts
          zip -r snake-macos-arm64.zip snake-macos-arm64
          rm snake-macos-arm64
          ls -la .

      # 检查下载的文件结构
      - name: Check downloaded files
        run: find artifacts -type f | sort

      # 打包仓库源码为tar.gz文件
      - name: Package repository source code
        run: |
          # 创建仓库压缩包，文件名包含标签名
          TAG_NAME="${{ steps.get_tag.outputs.tag_name || github.ref_name }}"
          mkdir -p artifacts
          git archive --format=tar.gz --output=artifacts/snake-source-${TAG_NAME}.tar.gz HEAD
          ls -la artifacts/

      # 列出所有artifacts，用于调试
      - name: List all artifacts
        run: ls -la artifacts/ || echo "No artifacts found"

      # 上传所有artifacts到GitHub Release
      - name: Upload release assets
        uses: softprops/action-gh-release@v1
        with:
          # 文件路径不能与注释在同一行，否则会导致匹配失败
          files: |
            artifacts/snake-macos-*.zip
            artifacts/snake-source-${{ steps.get_tag.outputs.tag_name }}.tar.gz
          tag_name: ${{ steps.get_tag.outputs.tag_name }}
          name: Release ${{ steps.get_tag.outputs.tag_name }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # GitHub自动提供的令牌
